#!/usr/bin/make -f

include /usr/share/quilt/quilt.make

PYVERSION = $(shell pyversions -v -r | tr -d . )

CONFIGUREFLAGS = \
	--enable-static \
	--enable-shared \
	--disable-debug \
	--with-logging=none \
	--with-dht=on \
	--with-encryption=on \
	--with-ssl \
	--with-zlib=system \
	--disable-examples \
	--disable-tests \
	--enable-python-binding \
	--with-boost-system=boost_system-mt \
	--with-boost-filesystem=boost_filesystem-mt \
	--with-boost-thread=boost_thread-mt \
    --with-boost-python=boost_python-mt-py$(PYVERSION)

# override dh targets
override_dh_auto_configure:
	# overwrite config.{sub,guess} from autotools-dev
	cp -f /usr/share/misc/config.sub config.sub
	cp -f /usr/share/misc/config.guess config.guess
	# generate html docs
	(cd docs/ && $(MAKE) -f makefile)
	dh_auto_configure -- PTHREAD_LIBS="-lpthread" CFLAGS="$(CFLAGS)" \
		PYTHON_INSTALL_PARAMS="--root=$(CURDIR)/debian/tmp --install-layout=deb" \
		LDFLAGS="-Wl,--as-needed -lrt" $(CONFIGUREFLAGS)

override_dh_compress:
	dh_compress -Xcpp

override_dh_strip:
	dh_strip -a --dbg-package=libtorrent-rasterbar-dbg

override_dh_makeshlibs:
	dh_makeshlibs -a -V


build: build-stamp
build-stamp: $(QUILT_STAMPFN)
	dh build
	touch $@

clean: unpatch
	rm -f config.sub config.guess
	# delete the specific missing doc page added by fix_html_docs.patch
	# (fixed upstream, remove this line in next release)
	rm -f docs/libtorrent_plugins.html
	dh $@

install: build install-stamp
install-stamp:
	dh install
	touch $@

binary-arch: install
	dh $@

binary-indep: install
	dh $@

binary: binary-arch binary-indep

.PHONY: build clean binary-indep binary-arch binary install
