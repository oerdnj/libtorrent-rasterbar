#!/usr/bin/make -f

BOOST_VERSION = $(shell grep "\#define BOOST_VERSION " /usr/include/boost/version.hpp | cut -d " " -f 3 )
BOOST_PYTHON_MT = $(shell if test $(BOOST_VERSION) -lt 103900; then echo boost_python-mt-; fi )

PYVERSION = $(shell pyversions -v -r | tr -d . )

CONFIGUREFLAGS = \
  --enable-static \
  --enable-shared \
  --disable-debug \
  --with-logging=none \
  --with-dht=on \
  --with-encryption=on \
  --with-ssl \
  --with-zlib=system \
  --disable-examples \
  --disable-tests \
  --enable-python-binding \
  --with-boost-python=$(BOOST_PYTHON_MT)py$(PYVERSION)

%:
	dh --with quilt $@

override_dh_auto_configure:
	# overwrite config.{sub,guess} from autotools-dev
	if [ -r /usr/share/misc/config.sub ] && [ ! -f config.sub.backup ]; then \
		mv -v config.sub config.sub.backup; \
		cp -f /usr/share/misc/config.sub $(CURDIR)/config.sub; \
	fi

	if [ -r /usr/share/misc/config.guess ] && [ ! -f config.guess.backup ]; then \
		mv -v config.guess config.guess.backup; \
		cp -f /usr/share/misc/config.guess $(CURDIR)/config.guess; \
	fi

	# generate html docs
	(cd docs/ && $(MAKE) -f makefile)
	dh_auto_configure -- PTHREAD_LIBS="-lpthread" CFLAGS="$(CFLAGS)" \
		PYTHON_INSTALL_PARAMS="--root=$(CURDIR)/debian/tmp --install-layout=deb" \
		LDFLAGS="-Wl,--as-needed -lrt" $(CONFIGUREFLAGS)

override_dh_auto_clean:
	dh_auto_clean

	# restore backup config.{sub,guess}
	if [ -f config.sub.backup ]; then \
		mv -fv config.sub.backup config.sub; \
	fi

	if [ -f config.guess.backup ]; then \
		mv -fv config.guess.backup config.guess; \
	fi

override_dh_compress:
	dh_compress -Xcpp

override_dh_strip:
	dh_strip -a --dbg-package=libtorrent-rasterbar-dbg

override_dh_makeshlibs:
	dh_makeshlibs -a -V
